# Authorization

## Starting now, Miele supports an additional OAuth2 Provider that can be used to issue tokens with device-specific permissions

The new Miele OAuth2 Provider supports the following endpoints and **should be used for your developments**.

- **Auth URL:** `https://auth.domestic.miele-iot.com/partner/realms/mcs/protocol/openid-connect/auth`
- **Token URL:** `https://auth.domestic.miele-iot.com/partner/realms/mcs/protocol/openid-connect/token`

The OAuth2 Authorization Code Grant Flow with device-specific permissions.

<div style="margin-top: 40px"></div>

![OAuth2 Authorization Code Grant Flow](/images/miele-authorization-flow.svg)

<div style="margin-top: 64px"></div>

:::step A

The client application requests authorization to access the Miele 3rd Party API

| KEY | EXPLANATION | COMMENT |
| --- | ----------- | ------- |
| <mark>client_id</mark> | The unique client ID assigned to your application during registration. | required |
| <mark>response_type</mark> | Specifies that your app expects an authorization code in return. | required |
| <mark>redirect_uri</mark> | The URL your user will be redirected to after completing the authorization flow. | required |
| <mark>state</mark> | A random string generated by your app to maintain request integrity and prevent CSRF attacks. You'll validate this value later. | optional |
| <mark>scope</mark> | Defines the permissions your app is requesting. Multiple scopes can be requested by separating them with %20 (URL-encoded space). | required |
| | Available scopes include: | |
| | • `mcs_thirdparty_read`: Grants read access to appliance states, available actions, programs, and other appliance details. | optional |
| | • `mcs_thirdparty_write`: Allows triggering actions like powering on appliances or starting programs. | optional |
| | • `mcs_thirdparty_media`: Enables access to media generated by appliances (e.g., oven camera images). | optional |
| | • `openid`: Required for technical reasons.| **mandatory** |
| | For a detailed mapping of scopes to endpoints, refer to the [API Explorer](/swagger) documentation. | |

:::

<div style="margin-top: 48px"></div>

:::step B

The user authenticates using their username, password, and the Miele subsidiary associated with their account. As part of the OAuth2 authorization flow, the authorization server redirects the user to a dedicated consent page.
On this page, the user explicitly grants your application permission to access the Miele Third-Party API. Additionally, the user can select which of their connected appliances your application is allowed to access. This means access is scoped per device, and your application may not receive access to all appliances in the user's account—only to those explicitly approved.

| KEY | EXPLANATION | COMMENT |
| --- | ----------- | ------- |
| <mark>e-mail</mark> | The e-mail address belonging to the Miele user account | required |
| <mark>password</mark> | The corresponding password | required |
| <mark>country</mark> | The Miele subsidiary the Miele user account belongs to | required |

:::

<div style="margin-top: 48px"></div>

:::step C

The Authorization server redirects to the client application and is passing the authorization code

| KEY | EXPLANATION | COMMENT |
| --- | ----------- | ------- |
| <mark>code</mark> | The server returns the authorization code in the query string | required |
| <mark>state</mark> | The server returns the same state value that you passed | optional |

:::

<div style="margin-top: 48px"></div>

:::step D

The client application is requesting an access_token by using the authorization code.

| KEY | EXPLANATION | COMMENT |
| --- | ----------- | ------- |
| <mark>client_id</mark> | The client ID you received after the registration | required |
| <mark>client_secret</mark> | The client secret you received after the registration | required |
| <mark>code</mark> | The authorization code returned by the authorization server before to complete | required |
| <mark>grant_type</mark> | The grant type for this flow is authorization_code | always <mark>authorization_code</mark>|
| <mark>redirect_uri</mark> | Must be identical to the redirect URI provided in the original link | required |

:::


<div style="margin-top: 48px"></div>


:::step E

The Authorization server returns the access token. The token is issued as a signed JWT token containing multiple claims which contain the country of the customer, the appliance serial numbers that have been granted access to.
<Beispieltoken>

|  KEY | EXPLANATION | COMMENT |  
| --- | ----------- | ------- |
| <mark>access_token</mark> | Temporary token used for accessing protected resources | Used in API calls |  
| <mark>refresh_token</mark> | Token used to obtain a new access token without re-authentication | Longer lifespan than access  token |  
| <mark>refresh_expires_in</mark> | Validity period of the refresh token in seconds | |  
| <mark>token_type</mark> | Type of token, typically "Bearer" | Used in Authorization header |  
| <mark>expires_in</mark> | Validity period of the access token in seconds | |  
| <mark>not-before-policy</mark> | Timestamp indicating when the token becomes valid | Unix timestamp |
| <mark>session_state</mark> | Identifier used to track the user's session | Used in OpenID Connect |  

</Beispieltoken>

:::

<div style="margin-top: 48px"></div>

:::step F

The client application has to use the access_token for all subsequent API calls

| KEY | EXPLANATION | COMMENT |
| --- | ----------- | ------- |
| <mark>access_token</mark> | The access_code for the every single API call | required |

:::

<div style="margin-top: 48px"></div>

:::step G

The Resource Server returns the requested resources

:::

<div style="margin-top: 48px"></div>

:::relevant-articles Relevant articles
- [OAuth2 with device-specific permissions](/authorization2.md)
- [OAuth2](/authorization1.md)
:::
